FROM jumanjiman/infiniband:7-20160311T2137-git-5ddacd5

ARG BUILD_DATE
ARG VCS_REF

LABEL \
    org.label-schema.name="jumanjiman/opensm" \
    org.label-schema.description="Infiniband subnet manager" \
    org.label-schema.url="https://github.com/jumanjihouse/docker-opensm" \
    org.label-schema.vcs-url="https://github.com/jumanjihouse/docker-opensm.git" \
    org.label-schema.docker.dockerfile="/src/Dockerfile" \
    org.label-schema.vcs-type="Git" \
    org.label-schema.license="GPLv2" \
    org.label-schema.build-date=$BUILD_DATE \
    org.label-schema.vcs-ref=$VCS_REF

# The following environment variables control opensm behavior:
#
# OSM_TMP_DIR: controls the directory in which the temporary files
# generated by opensm are created. These files are: opensm-subnet.lst,
# opensm.fdbs, and opensm.mcfdbs. By default, this directory is /var/log.
#
# OSM_CACHE_DIR: opensm stores certain data to the disk such that
# subsequent runs are consistent. The default directory used is
# /var/cache/opensm. The following files are included in it:
#
# guid2lid  - stores the LID range assigned to each GUID
# guid2mkey - stores the MKey previously assiged to each GUID
# neighbors - stores a map of the GUIDs at either end of each link
#             in the fabric
#
ENV OSM_TMP_DIR=/var/log/ \
    OSM_CACHE_DIR=/var/cache/opensm/

# Allow to run container read-only and avoid this message:
# osm_dump_qmap_to_file: cannot create file '/var/log//opensm-subnet.lst': Read-only file system
VOLUME $OSM_TMP_DIR

# Replace this with --tmpfs option in docker 1.10 or higher.
VOLUME $OSM_CACHE_DIR

COPY . /

RUN cd /etc/rdma && \
    patch -p0 < rdma.conf.patch && \
    patch -p0 < opensm.conf.patch

ENTRYPOINT ["/start.sh"]

# Our default runtime options.
# 0x07 is the sum of:
# 0x01 - ERROR (error messages)
# 0x02 - INFO (basic messages, low volume)
# 0x04 - VERBOSE (interesting stuff, moderate volume)
CMD ["-p", "15", "-D", "0x07"]
