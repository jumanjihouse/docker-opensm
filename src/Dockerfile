FROM centos:7

# If you change this version, you must also update circle.yml
ENV OPENSM_RPM_VERSION="3.3.19-1.el7.x86_64"

RUN yum -y install \
      ibutils \
      infiniband-diags \
      infinipath-psm libcxgb3 libcxgb4 libipathverbs libmthca libmlx4 libmlx5 libnes libocrdma \
      opensm-${OPENSM_RPM_VERSION} \
      patch \
      qperf \
      && \
    yum clean all

# The following environment variables control opensm behavior:
#
# OSM_TMP_DIR: controls the directory in which the temporary files
# generated by opensm are created. These files are: opensm-subnet.lst,
# opensm.fdbs, and opensm.mcfdbs. By default, this directory is /var/log.
#
# OSM_CACHE_DIR: opensm stores certain data to the disk such that
# subsequent runs are consistent. The default directory used is
# /var/cache/opensm. The following files are included in it:
#
# guid2lid  - stores the LID range assigned to each GUID
# guid2mkey - stores the MKey previously assiged to each GUID
# neighbors - stores a map of the GUIDs at either end of each link
#             in the fabric
#
ENV OSM_TMP_DIR=/var/log/ \
    OSM_CACHE_DIR=/var/cache/opensm/

# Allow to run container read-only and avoid this message:
# osm_dump_qmap_to_file: cannot create file '/var/log//opensm-subnet.lst': Read-only file system
VOLUME $OSM_TMP_DIR

# Replace this with --tmpfs option in docker 1.10 or higher.
VOLUME $OSM_CACHE_DIR

COPY . /

RUN cd /etc/rdma && \
    patch -p0 < rdma.conf.patch && \
    patch -p0 < opensm.conf.patch

ENTRYPOINT ["/start.sh"]

# Our default runtime options.
# 0x07 is the sum of:
# 0x01 - ERROR (error messages)
# 0x02 - INFO (basic messages, low volume)
# 0x04 - VERBOSE (interesting stuff, moderate volume)
CMD ["-p", "15", "-D", "0x07"]
